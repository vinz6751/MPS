' Programme d'extraction des bidules et pacmans
' Vinz / MPS
'
' Variables globales
' fichier d'entr‚e (PI1 non compress‚)
fichier$="f:\mps\god\elite\bidules.pi1"
' dossier de sortie (pr‚fix‚ … tous les fichiers g‚n‚r‚s)
dossier$="f:\mps\god\elite\"
' Variables de travail
image$=STRING$(32000,0)
'
'
@extraction("atari.bmp",90,13,135,56)
@extraction("bidules.bmp",257,2,314,57)
@extraction("pacmano.bmp",24,157,49,180)
@extraction("pacmanf.bmp",56,157,82,180)
@extraction("fantomes.bmp",86,157,208,180)
'
'
PROCEDURE extraction(fichier_sortie$,x1&,y1&,x2&,y2&)
  LOCAL ecran$
  LOCAL oldrez%
  LOCAL sortie$
  LOCAL w&,h&
  LOCAL longueur_sortie&
  LOCAL i_sortie&
  LOCAL ix&,iy&
  '
  ' r‚serve m‚moire pour charger l'image
  SGET ecran$
  oldrez%=XBIOS(4)
  ~XBIOS(5,L:-1;L:-1,W:0) ! ST-BASSE
  '
  ' charge le fichier
  OPEN "I",#1,fichier$
  SEEK #1,34 ! Ignore la palette
  BGET #1,VARPTR(image$),32000
  CLOSE #1
  '
  ' Affiche l'image pour que POINT fonctionne
  SPUT image$
  '
  ' cr‚e le fichier de sortie et ‚crit l'en-tˆte (w et h)
  '
  w&=x2&-x1&+1
  h&=y2&-y1&+1
  longueur_sortie&=4+w&*h& ! 4 est la longueur de l'en-tˆte
  sortie$=STRING$(longueur_sortie&,0)
  '
  ' ‚crit l'en-tˆte
  DPOKE VARPTR(sortie$),w&
  DPOKE VARPTR(sortie$)+2,h&
  i_sortie&=4 ! 2*sizeof(word)
  '
  ' ‚crit un octet par pixel avec le num‚ro de couleur
  FOR iy&=y1& TO y2&
    FOR ix&=x1& TO x2&
      POKE VARPTR(sortie$)+i_sortie&,POINT(ix&,iy&)
      INC i_sortie&
    NEXT ix&
  NEXT iy&
  '
  ' enregistre le r‚sultat
  BSAVE dossier$+fichier_sortie$,VARPTR(sortie$),longueur_sortie&
  '
  ' restaure l'‚cran
  ~XBIOS(5,L:oldscreen%,L:oldscreen%,W:oldrez%)
  SPUT ecran$
RETURN
